---
title: Global movement of *Phytophthora* species through the plant trade
author: ""
date: ""
output: html_document
---

###Import risk factors

International trade in live plants is considered the main pathway for the introduction of plant pests and pathogens species to new geographic regions, but climate matching, biosecurity and pest reporting will also influence how pests and pathogens spread globally. By selecting import risk factors from the menu you can view global data on these different drivers of new arrivals of plant pests and pathogens. We have used these risk factors to build a model of *Phytophthora* import risk to the UK from exporting countries. By clicking on each country, you can view a list of the *Phytophthora* species that have been reported there and the relative risk of these species arriving in the UK, if not already present. We have also used biological characteristics or traits of these *Phytophthora* species to help predict which species may be more likely to be transported to and establish in new regions. These traits include thermal tolerance range and the presence and morphology of survival structures allowing them to persist in soil and asymptomatic hosts. 

The video below demonstrates the ways you can interact with the data and maps.  
  
*LB: I haven't made this material yet. This is a random YouTube tutorial about RMarkdown so I could test if we could embed a video within the webpage. I think we should wait for the project meeting to see what Mike and Mariella think would be the best way to communicate the tools to stakeholders and how to best fit in with the stakeholder activities they have planned*     
   
     
<iframe width="560" height="315" src="https://www.youtube.com/embed/6A5EpqqDOdk" frameborder="0" allowfullscreen></iframe>    
   
   
  
  
  
```{r setup, echo = FALSE}

knitr::opts_chunk$set(echo = FALSE)

```

```{r include=FALSE}
library(leaflet)
library(RColorBrewer)
library(readr)
library(countrycode)
library(dplyr)
library(geosphere)
library(rgeos)
library(reshape2)
library(htmlTable)
library(rgdal)
library(sp)
library(leafem)
library(raster)
library(htmlwidgets)



load("data/export_risk_composite.rData")



# get a nice world map - someone recommeded this one:
# download.file(file.path('http://www.naturalearthdata.com/http/',
#                         'www.naturalearthdata.com/download/50m/cultural',
#                         'ne_50m_admin_0_countries.zip'), 
#               f <- tempfile())

#unzip(f, exdir=tempdir())

world <- readOGR(dsn = 'data', layer = 'ne_50m_admin_0_countries', encoding='UTF-8')
export_risk_composite$GU_A3 <- export_risk_composite$exporter_iso3
export_risk_composite <- export_risk_composite[export_risk_composite$importer_iso3 %in% world$GU_A3,]
world <- merge(world, export_risk_composite, all.x= TRUE) # 

# where no Phytophthora are reported (0) convert richness to NA 
world@data$Phytophthora_richness[world@data$Phytophthora_richness == 0] <- NA

pal_richness <- colorNumeric("YlOrRd", domain = log(world@data$Phytophthora_richness))
pal_risk <- colorNumeric("YlOrRd", domain = world@data$composite_export_risk)
pal_climate <- colorNumeric("YlOrRd", domain = log(1+world@data$climate_raw))
pal_trade <- colorNumeric("YlOrRd", domain = log(1+world@data$trade_raw))
pal_expproactive <- colorNumeric("YlOrRd", domain = world@data$expproactive_raw)
```

```{r map_flows, warning=FALSE, message=FALSE}
# make the interactive map

#"annual exports to UK (metric tons of live plants)"

  leaflet(data = world, width = "100%") %>% addTiles(options = providerTileOptions(minZoom=1, maxZoom=10)) %>% 
  addPolygons(
    fillColor = ~pal_risk(world@data$composite_export_risk),
    group = "export risk (all risk factors)",
    weight = 1,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 0.7,
    popup = ~species_table,
    popupOptions = c(maxWidth = 600),
    highlight = highlightOptions(
      weight = 1.5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE)
  ) %>%
  addPolygons(
    fillColor = ~pal_richness(log(world@data$Phytophthora_richness)),
    group = "Phytophthora richness",
    weight = 1,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 0.7,
    popup = ~species_table,
    popupOptions = c(maxWidth = 600),
    highlight = highlightOptions(
      weight = 1.5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE)
  ) %>%
  addPolygons(
    fillColor = ~pal_trade(log(1+world@data$trade_raw)),
    group = "annual exports to UK (metric tons of live plants)",
    weight = 1,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 0.7,
    popup = ~species_table,
    popupOptions = c(maxWidth = 600),
    highlight = highlightOptions(
      weight = 1.5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE)
  ) %>% 
  addPolygons(
    fillColor = ~pal_climate(log(1+world@data$climate_raw)),
    group = "climate similarity (1/Mahalanobis distance)",
   weight = 1,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 0.7,
    popup = ~species_table, 
   popupOptions = c(maxWidth = 600),
    highlight = highlightOptions(
      weight = 1.5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE)
   )  %>% 
  addPolygons(
    fillColor = ~pal_expproactive(world@data$expproactive_raw),
    group = "exporter biosecurity capacity",
    weight = 1,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 0.7,
    popup = ~species_table,
    popupOptions = c(maxWidth = 600),
    highlight = highlightOptions(
      weight = 1.5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE)
  ) %>%
  addLegend(pal = pal_risk, 
            values = ~composite_export_risk,
            group = "export risk (all risk factors)",
            position = "bottomleft",
            title = "export risk (probability of new arrival in UK)") %>% 
  addLegend(pal = pal_richness, 
            values = ~log(Phytophthora_richness),
            group = "Phytophthora richness",
            position = "bottomleft",
            title = "# Phytophthora species reported") %>% 
  addLegend(pal = pal_trade, 
            values = ~log(1+trade_raw),
            labFormat = labelFormat(transform = function(x) exp(x) - 1, digits = 0),
            group = "annual exports to UK (metric tons of live plants)",
            position = "bottomleft",
            title = "annual exports to UK (metric tons of live plants)") %>% 
  addLegend(pal = pal_climate, 
            values = ~log(1+climate_raw), 
            labFormat = labelFormat(transform = function(x) exp(x) - 1, digits = 3),
            group = "climate similarity (1/Mahalanobis distance)",
            position = "bottomleft",
            title = "climate similarity (1/Mahalanobis distance)")  %>%
  addLegend(pal = pal_expproactive, 
            values = ~expproactive_raw, 
            group = "exporter biosecurity capacity",
            position = "bottomleft",
            title = "exporter biosecurity capacity") %>% 
  addLayersControl(
        baseGroups = c("export risk (all risk factors)",
                       "Phytophthora richness",
                       "annual exports to UK (metric tons of live plants)", 
                       "climate similarity (1/Mahalanobis distance)", 
                       "exporter biosecurity capacity"),
        options = layersControlOptions(collapsed = FALSE)
       ) %>% 
  # this section is a fudge to try to sync the legends with the layers shown when toggling between risk factors
  # amazingly, there is no inbuilt way to do this with baselayers (only with overlaid layers, where more than one layer can be shown at once)
htmlwidgets::onRender("
    function(el, x) {
      var updateLegend = function () {
          var selectedGroup = document.querySelectorAll('input:checked')[0].nextSibling.innerText.substr(1);

          document.querySelectorAll('.legend').forEach(a => a.hidden=true);
          document.querySelectorAll('.legend').forEach(l => {
            if (l.children[0].children[0].innerText == selectedGroup) l.hidden=false;
          });
      };
      updateLegend();
      this.on('baselayerchange', e => updateLegend());
    }") %>% 
  addHomeButton(extent(world), layer.name = "Reset") 

```

###Feedback

Thank you for taking the time to explore these tools. Please follow the link below to complete your feedback. Your responses will be used to understand the value of information about international trade flows in supporting plant health awareness in planting and procurement decisions for environmental and landscaping purposes.  
  
*LB: It may be possible for us to embed a Google Forms item within the page (see https://github.com/ramnathv/RGoogleForms). However, we may need something more flexible for our questionnaire, in which case a link openeing in a new tab might work better. This is just a mock-up questionnaire...*  

## [Enter my feedback - import risk models](<https://docs.google.com/forms/d/182WIK4SZFv0hQu9YyJ0FOddkD0I5w-HYJWm50hRDcyU/edit?usp=sharing>)



